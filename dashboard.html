<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <title>Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            margin: 0;
            background-color: #f4f4f4;
        }
        .sidebar {
            width: 250px;
            background: #86838F;
            color: white;
            padding: 20px;
            height: 100vh;
        }
        .sidebar h2 {
            text-align: center;
        }
        .sidebar a {
            display: block;
            color: white;
            text-decoration: none;
            margin: 15px 0;
            padding: 12px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            background: #6e6b75;
            transition: background 0.3s;
        }
        .sidebar a:hover {
            background: #8b8694;
        }
        .content {
            flex-grow: 1;
            padding: 20px;
        }
        .content > div {
            display: none;
        }
        .content .active {
            display: block;
        }
        .stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            border-radius: 10px;
            border: 2px solid black;
            flex: 1;
            margin: 5px;
        }
        .stat-card span {
            display: block;
            font-size: 28px;
            margin-top: 5px;
        }
        .btn-new {
            background: #86838F;
            color: white;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            border-radius: 10px;
            border: none;
            float:right;
            transition: background 0.3s;
            width: 160px;
        }
        .btn-new:hover {
            background: #4e4c54;
        }

        @media print {
    .delete-btn {
        display: none; /* Hide the Edit button when printing */
    }
}

        .delete-btn {
            background-color: red;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 5px;
        }
        .employee-list, .table-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        th {
            background: #86838F;
            color: white;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: rgb(255, 255, 255);
            padding: 50px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
            width: 350px;
            max-width: 90%;
            text-align: center;
        }

        .close {
            float: right;
            font-size: 24px;
            cursor: pointer;
        }

        .dashboard-box {
    display: inline-block;
    text-align: center;
    padding: 20px;
    border: 2px solid #ddd;
    border-radius: 10px;
    background-color: #f8f8f8;
    transition: 0.3s;
    text-decoration: none;
    color: black;
    width: 165px;
}

.dashboard-box:hover {
    background-color: #ddd;
    cursor: pointer;
}
@media print {
    body {
        visibility: hidden;
    }
    #attendance-section {
        visibility: visible;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
    }
    #print-btn {
        display: none;
    }
    .sidebar, .navbar {
        display: none; /* Hides sidebar and navigation */
    }
}

.edit { background: #007bff; color: white; padding: 5px 10px; border: none; cursor: pointer; }
        .delete { background: #dc3545; color: white; padding: 5px 10px; border: none; cursor: pointer; }
        
        .container { width: 80%; margin: 20px auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0px 0px 10px #ccc; }
        .header { background: #007bff; color: white; padding: 15px; text-align: center; font-size: 20px; border-radius: 5px; }
        .form-group { margin: 15px 0; }
        label { display: block; font-weight: bold; }
        input, textarea { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; }
        button { padding: 10px 15px; border: none; cursor: pointer; }
        .save { background: #007bff; color: white; }
        .cancel { background: #dc3545; color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        table, th, td { border: 1px solid #ddd; }
        th, td { padding: 10px; text-align: left; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>SPIDERMAN25</h2>
        <p>  <img src="th.jpg" alt="Peter Parker" width="60" height="60" style="border-radius: 50%; vertical-align: middle; margin-right: 8px;">
            Peter Parker </p>
            <a href="#" onclick="showSection('home')">
                <i class="fa fa-home"></i> Home
            </a>
            <a href="#" onclick="showSection('attendance')">
                <i class="fa fa-calendar-check"></i> Attendance
            </a>
            
            <a href="#" onclick="showSection('payroll')">
                <i class="fa fa-money-bill-wave"></i> Payroll
            </a>
            <a href="#" onclick="showSection('deductions')">
                <i class="fa-solid fa-file-invoice-dollar"></i> Deductions
            </a>

            <a href="#" onclick="showSection('recentlyDeleted')">
                <i class="fa fa-trash-restore"></i> Recently Deleted
            
            <a href="#" id="logoutBtn">
                <i class="fa-solid fa-right-from-bracket"></i> Log Out
            </a>
    </div>
    
<div class="content">
    
        <div id="home" class="active">
            <h1>Dashboard</h1>      
            <a href="ccis.php" class="dashboard-box">
                <div>CCIS</div>

            </a>
            
            <a href="ccj.php" class="dashboard-box">
                <div>CCJ</div>
              
            </a>
            
            <a href="ctas.php" class="dashboard-box">
                <div>CTAS</div>
               
            </a>
            
            <a href="admin.php" class="dashboard-box">
                <div>Admin & Staff</div>
                
            </a>
            

                    <button class="btn-new" onclick="openEmployeeForm()">+ New Employee</button>
                    

                    <div class="employee-list">
                        <h2>Employee's List</h2>
                        
            <table>
                <thead>
                    <tr>
                        <th>Employee ID</th>
                        <th>Name</th>
                        <th>Department</th>
                        <th>Position</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                       
                    </tr>
                    <tr>
                    </tr>
                    <tr>
                       
                    </tr>
                    <tr>
                        
                    </tr>
                </tbody>
            </table>
        </div>
        </div>

        <div id="attendance">
            <h1>Attendance</h1>
            <button id="print-btn" onclick="printAttendance()">🖨 Print Attendance</button>
            <button class="btn-new" onclick="openAttendanceForm()">+ New Attendance</button>
            <table class="attendance-list">
                <thead>
                    <tr>
                        <th>Employee ID</th>
                        <th>Name</th>
                        <th>Date</th>
                        <th>Time In</th>
                        <th>Time Out</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Attendance records will be inserted here -->
                </tbody>
            </table>
        </div>   
   
        <div id="payroll">
            <h1>Payroll</h1>
            <button id="print-btn" onclick="printPayroll()">🖨 Print Payroll</button>
        
            <table id="payrollTable">
            
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Daily Rate</th>
                        <th>Hour Rate</th>
                        <th>Gross</th>
                        <th>Deductions</th>
                        <th>Net Pay</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                      
                    </tr>
                    <tr>
                      
                    </tr>
                    <tr>
                        
                    </tr>
                </tbody>
            </table>
        </div>


        
<div id="employeeForm" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEmployeeForm()">&times;</span>
        <h2>Add New Employee</h2>
        <form id="addEmployeeForm">
            <label for="emp_id">Employee ID:</label>
            <input type="text" id="emp_id" required><br>

            <label for="name">Name:</label>
            <input type="text" id="name" required><br>

            <label for="department">Department:</label>
            <select id="department">
            <option value="">Select Department</option>
            <option value="CCIS">CCIS</option>
            <option value="CTAS">CTAS</option>
            <option value="CCJ">CCJ</option>
            <option value="ADMIN AND STAFF">Admin & Staff</option>
            </select>

            <label for="position">Position:</label>
            <select id="position">
            <option value="">Select Position</option>
            <option value="Professor 6">Professor 6</option>
            <option value="Instructor">Instructor</option>
            <option value="Dean">Dean</option>
            </select>

            <button type="submit">Add Employee</button>
        </form>
    </div>
</div>
<div id="AttendanceForm" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeAttendanceForm()">&times;</span>
        <h2>Add New Attendance</h2>
        <form id="addAttendanceForm">
            <label for="id">Employee ID:</label>
            <input type="text" id="id" name="id"><br> <!-- Add name="id" -->

            <label for="name">Name:</label>
            <input type="text" id="name" name="name" required><br>

            <label for="date">Date:</label>
            <input type="date" id="date" name="date" required><br>

            <label for="time_in">Time in:</label>
            <input type="time" id="time_in" name="time_in" required><br>

            <label for="time_out">Time out:</label>
            <input type="time" id="time_out" name="time_out"><br>
            
            <button type="submit">Add Attendance</button>
        </form>
    </div>
</div>

<div id="editAttendanceForm" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditAttendanceForm()">&times;</span>
        <h2>Edit Attendance</h2>
        <form id="editAttendanceForm">
            <input type="hidden" id="edit_id" name="id"> <!-- Hidden input for employee ID -->
            <label for="edit_time_out">Time out:</label>
            <input type="time" id="edit_time_out" name="time_out" required><br>
            <button type="submit">Save Changes</button>
        </form>
    </div>
</div>

    <div id="deductions" class="content">
        <h1>Deductions</h1>
        <button class="btn-new" onclick="openDeductionForm()">+ Add Deduction</button>
    
        <!-- Deduction Form Modal -->
        <div id="deductionFormModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close" onclick="closeDeductionForm()">&times;</span>
                <h2>Add New Deduction</h2>
                <form id="deductionForm">
                    <input type="text" id="description" placeholder="Deduction Description" required>
                    <input type="number" id="amount" placeholder="Amount" step="0.01" required>
                    <button type="submit">Save Deduction</button>
                </form>
            </div>
        </div>
    
        <!-- Deduction List Table -->
        <table id="deductionList">
            <thead>
                <tr>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Deductions will be listed here -->
            </tbody>
        </table>
    </div>

<div id="recentlyDeleted" class="content">
    <h1>Recently Deleted Employees</h1>
    <table>
        <thead>
            <tr>
                <th>Employee ID</th>
                <th>Name</th>
                <th>Department</th>
                <th>Position</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="recentlyDeletedList">
            <!-- Recently deleted employees will be inserted here -->
        </tbody>
    </table>
</div>

    <script>
        function showSection(sectionId) {
            document.querySelectorAll('.content > div').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
        }

        document.addEventListener("DOMContentLoaded", () => {
            if (localStorage.getItem("isAuthenticated") !== "true") {
                window.location.href = "index.html";
            }
        });

        document.getElementById("logoutBtn").addEventListener("click", () => {
            localStorage.removeItem("isAuthenticated");
            window.location.href = "index.html";
        });
        function openEmployeeForm() {
        document.getElementById("employeeForm").style.display = "flex";
    }

    function closeEmployeeForm() {
        document.getElementById("employeeForm").style.display = "none";
    }

    function openAttendanceForm() {
        document.getElementById("AttendanceForm").style.display = "flex";
    }

    function closeAttendanceForm() {
        document.getElementById("AttendanceForm").style.display = "none";
    }

    document.getElementById("addEmployeeForm").addEventListener("submit", function (event) {
    event.preventDefault();

    let emp_id = document.getElementById("emp_id").value;
    let name = document.getElementById("name").value;
    let department = document.getElementById("department").value;
    let position = document.getElementById("position").value;

    fetch("http://localhost/payroll/login/add_employee.php", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `emp_id=${emp_id}&name=${name}&department=${department}&position=${position}`
    })
    .then(response => response.text()) // Ensure text is returned
    .then(data => {
        if (data.trim() === "") {
            alert("Error: Empty response from server.");
        } else {
            alert(data); // Show success or error message
        }
        closeEmployeeForm();
        fetchEmployees(); // Refresh employee list
    })
    .catch(error => alert("Fetch error: " + error));
});

function fetchEmployees() {
    fetch("fetch.php")
        .then(response => response.json())
        .then(data => {
            let table = document.querySelector(".employee-list tbody");
            table.innerHTML = "";
            data.forEach(row => {
                let tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${row.emp_id}</td>
                    <td>${row.name}</td>
                    <td>${row.department}</td>
                    <td>${row.position}</td>
                    <td><button class='delete-btn' onclick='deleteEmployee(${row.emp_id})'>Delete</button></td>
                `;
                table.appendChild(tr);
            });
        })
        .catch(error => console.error("Error fetching data:", error));
}

document.getElementById("addAttendanceForm").addEventListener("submit", function (event) {
    event.preventDefault(); // Prevent default form submission


    let formData = new FormData(this); // Automatically gets all input values

    for (let pair of formData.entries()) {
        console.log(pair[0] + ': ' + pair[1]);
    }

    fetch("http://localhost/payroll/login/attendance.php", {
        method: "POST",
        body: formData
    })
    .then(response => response.text())
    .then(data => {
        if (data.trim() === "") {
            alert("Error: Empty response from server.");
        } else {
            alert(data); // Show success or error message
            fetchAttendance(); // Refresh the attendance list
        }
        closeAttendanceForm();
    })
    .catch(error => alert("Fetch error: " + error));
});


function fetchAttendance() {
    fetch("fetch_attendance.php")
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            let table = document.querySelector(".attendance-list tbody");
            table.innerHTML = ""; // Clear table before appending new data

            data.forEach(row => {
                let tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${row.id}</td>
                    <td>${row.name}</td>
                    <td>${row.date}</td>
                    <td>${row.time_in || '---'}</td>
                    <td>${row.time_out || '---'}</td>
                    <td><button class='delete-btn' onclick='editAttendance("${row.id}")'>Edit</button></td>
                `;
                table.appendChild(tr);
            });
        })
        .catch(error => console.error("Error fetching data:", error));
}



// Call fetchAttendance() when the page loads
document.addEventListener("DOMContentLoaded", function () {
    // Ensure the editAttendance function is defined in the global scope
    window.editAttendance = function (id) {
        console.log("Edit button clicked for Employee ID:", id); // Debugging log

        fetch("get_attendance.php?emp_id=" + encodeURIComponent(id))
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log("Received data:", data); // Debug log
                if (data.error) {
                    alert("❌ Error: " + data.error);
                } else {
                    // Populate the form fields with the fetched data
                    document.getElementById("edit_id").value = data.id;
                    document.getElementById("edit_time_out").value = data.time_out || '';
                    document.getElementById("editAttendanceForm").style.display = "block";
                }
            })
            .catch(error => console.error("Error fetching attendance:", error));
    };

    document.getElementById("editAttendanceForm").addEventListener("submit", function (event) {
        event.preventDefault();

        // Get the value of the time out input
        const timeOut = document.getElementById("edit_time_out").value;
        const id = document.getElementById("edit_id").value; // Ensure you have an input for the employee ID

        // Validate the timeOut value (example: check if it's not empty)
        if (!timeOut) {
            alert("Time out value cannot be empty.");
            return;
        }

        // Send data to the server using fetch API
        fetch('save_attendance.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `id=${id}&time_out=${timeOut}`,
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert("Error: " + data.error);
            } else {
                alert(data.success);
                closeEditAttendanceForm();
                fetchAttendance(); // Refresh the attendance list to reflect changes
            }
        })
        .catch((error) => {
            console.error('Error:', error);
            alert("An error occurred while saving attendance.");
        });
    });

    function closeEditAttendanceForm() {
        // Close the modal
        const form = document.getElementById("editAttendanceForm");
        if (form) {
            form.style.display = "none";
        }
    }

    function fetchAttendance() {
        fetch("fetch_attendance.php")
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                let table = document.querySelector(".attendance-list tbody");
                table.innerHTML = ""; // Clear table before appending new data

                data.forEach(row => {
                    let tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${row.id}</td>
                        <td>${row.name}</td>
                        <td>${row.date}</td>
                        <td>${row.time_in || 'N/A'}</td>
                        <td>${row.time_out || 'N/A'}</td>
                        <td><button class='delete-btn' onclick='editAttendance("${row.id}")'>Edit</button></td>
                    `;
                    table.appendChild(tr);
                });
            })
            .catch(error => console.error("Error fetching data:", error));
    }

    // Call fetchAttendance() when the page loads
    fetchAttendance();
});



function deleteEmployee(emp_id) {
    if (!confirm("Are you sure you want to delete this employee?")) return;

    fetch("http://localhost/payroll/login/delete.php", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `emp_id=${emp_id}`
    })
    .then(response => response.text())
    .then(data => {
        alert(data); // Show success or error message

        // Refresh both the active employee list and the recently deleted list
        fetchEmployees();
        fetchRecentlyDeleted();
    })
    .catch(error => {
        console.error("Fetch error:", error);
        alert("Fetch error: " + error);
    });
}

function fetchEmployees() {
    fetch("fetch.php")
        .then(response => response.json())
        .then(data => {
            let table = document.querySelector(".employee-list tbody");
            table.innerHTML = "";
            data.forEach(row => {
                // Only display employees that are not marked as deleted
                if (!row.deleted_at) {
                    let tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${row.emp_id}</td>
                        <td>${row.name}</td>
                        <td>${row.department}</td>
                        <td>${row.position}</td>
                        <td><button class='delete-btn' onclick='deleteEmployee(${row.emp_id})'>Delete</button></td>
                    `;
                    table.appendChild(tr);
                }
            });
        })
        .catch(error => console.error("Error fetching data:", error));
}

function fetchRecentlyDeleted() {
    fetch("fetch_recently_deleted.php")
        .then(response => response.json())
        .then(data => {
            let table = document.getElementById("recentlyDeletedList");
            table.innerHTML = "";
            data.forEach(row => {
                let tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${row.emp_id}</td>
                    <td>${row.name}</td>
                    <td>${row.department}</td>
                    <td>${row.position}</td>
                    <td>
                        <button class='restore-btn' onclick='restoreEmployee(${row.emp_id})'>Restore</button>
                        <button class='delete-btn' onclick='permanentlyDeleteEmployee(${row.emp_id})'>Delete Permanently</button>
                    </td>
                `;
                table.appendChild(tr);
            });
        })
        .catch(error => console.error("Error fetching data:", error));
}

// Call these functions when the page loads
document.addEventListener("DOMContentLoaded", () => {
    fetchEmployees();
    fetchRecentlyDeleted();
});


function saveEmployee() {
    let emp_id = document.getElementById("emp_id").value;
    let name = document.getElementById("name").value;
    let department = document.getElementById("department").value; // Get selected position
    let position = document.getElementById("position").value;
    if (emp_id && name && department && position) {
        fetch("add_employee.php", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: "emp_id=" + encodeURIComponent(emp_id) + 
                  "&name=" + encodeURIComponent(name) + 
                  "&department=" + encodeURIComponent(department)+
                  "&position=" + encodeURIComponent(position) 
        })
        .then(response => response.text())
        .then(data => {c
            alert(data); // Show success message

            // Redirect based on selected position
            if (department === "ccis") {
                window.location.href = "ccis.php";
            } else if (department === "ctas") {
                window.location.href = "ctas.php";
            } else if (department === "ccj") {
                window.location.href = "ccj.php";
            } else if (department === "admin") {
                window.location.href = "admin.php";
            } else {
                location.reload(); // Refresh if no matching position
            }
        });
    } else {
        alert("Please fill in all fields.");
    }
}

fetch("payroll.php")
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        let tableBody = document.querySelector("#payrollTable tbody");
        tableBody.innerHTML = ""; // Clear previous data

        data.forEach(emp => {
            let row = `<tr>
                <td>${emp.id}</td>
                <td>${emp.name}</td>
                <td>${emp.daily_rate}</td>
                <td>${emp.hourly_rate}</td>
                <td>${emp.deductions}</td>
                <td>${emp.gross_pay}</td>
                <td>${emp.net_pay}</td>
            </tr>`;
            tableBody.innerHTML += row;
        });
    })
    .catch(error => console.error("Error loading payroll data:", error));

    function printAttendance() {
    let tableClone = document.querySelector(".attendance-list").cloneNode(true);
    let printWindow = window.open("", "", "width=800,height=600"); // Open new window
    tableClone.querySelectorAll('.delete-btn').forEach(button => button.remove());

    // Add the header content
    let headerContent = `
        <div style="text-align: center; margin-bottom: 20px; margin-left: 10px;">
            <img src="IMG_2236.jpeg" alt="Bohol Island State University" style="width: 1000px;">

        </div>
    `;

    printWindow.document.write(`
        <html>
            <head>
                <title>Print Attendance</title>
                <style>
                    table { width: 100%; border-collapse: collapse; }
                    th, td { border: 1px solid black; padding: 8px; text-align: center; }
                    th { background-color: #f2f2f2; }
                </style>
            </head>
            <body>
                ${headerContent}
                <h2>Attendance Records</h2>
                ${tableClone.outerHTML}
                <script>
                    setTimeout(() => { window.print(); window.close(); }, 500);
                <\/script>
            </body>
        </html>
    `);
}



function printPayroll() {
    // Select the table element with the class 'payroll-list'
    let table = document.querySelector("#payrollTable");

    // Check if the table element exists
    if (!table) {
        console.error("Payroll table not found in the DOM.");
        return;
    }

    // Get the outer HTML of the table
    let tableHTML = table.outerHTML;

    // Open a new print window
    let printWindow = window.open("", "", "width=800,height=600");

    // Define the header content
    let headerContent = `
        <div style="text-align: center; margin-bottom: 20px; margin-left: 10px;">
            <img src="IMG_2236.jpeg" alt="Bohol Island State University" style="width: 1000px;">
        </div>
    `;

    // Write the HTML content to the print window
    printWindow.document.write(`
        <html>
            <head>
                <title>Print Payroll</title>
                <style>
                    body { font-family: Arial, sans-serif; text-align: center; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid black; padding: 8px; text-align: center; }
                    th { background-color: #f2f2f2; }
                </style>
            </head>
            <body>
                ${headerContent}
                <h2>Payroll Report</h2>
                ${tableHTML}
                <script>
                    setTimeout(() => { window.print(); window.close(); }, 500);
                <\/script>
            </body>
        </html>
    `);

    // Close the print window after printing
    printWindow.document.close();
}

let deduction = [];

// Load deductions from the server when the page loads
document.addEventListener("DOMContentLoaded", function() {
    fetchDeductions();
    // Attach the event listener to the form
    document.getElementById("deductionForm").addEventListener("submit", saveDeduction);
});

// Function to open the deduction form modal
function openDeductionForm() {
    document.getElementById("deductionFormModal").style.display = "flex";
}

// Function to close the deduction form modal
function closeDeductionForm() {
    document.getElementById("deductionFormModal").style.display = "none";
}

function saveDeduction(event) {
    event.preventDefault(); // Prevent the default form submission
    let description = document.getElementById("description").value.trim();
    let amount = document.getElementById("amount").value.trim();

    // Validate input
    if (description === "") {
        alert("Please enter a valid deduction name.");
        return;
    }

    // Check if the amount is a valid number and greater than zero
    amount = parseFloat(amount);
    if (isNaN(amount) || amount <= 0) {
        alert("Please enter a valid amount greater than zero.");
        return;
    }

    // Create a FormData object to send the data
    let formData = new FormData();
    formData.append("description", description);
    formData.append("amount", amount);

    // Send the form data to the server using Fetch API
    fetch("http://localhost/payroll/login/add_deduction.php", {
        method: "POST",
        body: formData
    })
    .then(response => response.text())
    .then(data => {
        if (data.trim() === "") {
            alert("Error: Empty response from server.");
        } else {
            alert(data); // Show success or error message
            fetchDeductions(); // Refresh the deductions list
        }
        closeDeductionForm();
    })
    .catch(error => alert("Fetch error: " + error));
}

// Function to fetch deductions from the server
function fetchDeductions() {
    fetch("fetch_deduction.php")
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            deductions = data; // Update the deductions array
            updateDeductionTable(); // Refresh the table
        })
        .catch(error => console.error("Error fetching data:", error));
}

// Function to update the deduction table
function updateDeductionTable() {
    let deductionList = document.getElementById("deductionList").querySelector("tbody");
    deductionList.innerHTML = ""; // Clear table before updating

    deductions.forEach((deduction) => {
        let row = `<tr>
            <td>${deduction.description}</td>
            <td>${deduction.amount}</td>
            <td>
                <button onclick="deleteDeduction(${deduction.id})">🗑 Delete</button>
            </td>
        </tr>`;
        deductionList.innerHTML += row;
    });
}

// Function to delete a deduction
function deleteDeduction(id) {
    // Send a request to the server to delete the deduction
    fetch("http://localhost/payroll/login/delete_deduction.php", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
        },
        body: `id=${id}`
    })
    .then(response => response.text())
    .then(data => {
        if (data.trim() === "") {
            alert("Error: Empty response from server.");
        } else {
            alert(data); // Show success or error message
            fetchDeductions(); // Refresh the deductions list
        }
    })
    .catch(error => alert("Fetch error: " + error));
}

async function fetchAttendanceAndCalculatePayroll() {
    try {
        let attendanceData = await fetchAttendanceData();
        let deductionsData = await fetchDeductionsData();

        // Debug: Log the fetched data
        console.log("Attendance Data:", attendanceData);
        console.log("Deductions Data:", deductionsData);

        calculatePayroll(attendanceData, deductionsData);
    } catch (error) {
        console.error("Error fetching and calculating payroll:", error);
    }
}

function calculatePayroll(attendanceData, deductionsData) {
    let payrollTableBody = document.querySelector("#payrollTable tbody");
    if (!payrollTableBody) {
        console.error("Payroll table body not found in the DOM.");
        return;
    }
    payrollTableBody.innerHTML = ""; // Clear previous data

    attendanceData.forEach(attendance => {
        let emp_id = attendance.id;
        let emp_name = attendance.name;
        let emp_timeIn = attendance.time_in;
        let emp_timeOut = attendance.time_out;

        let hoursWorked = calculateHoursWorked(emp_timeIn, emp_timeOut);
        let hour_rate = 150; // Example hourly rate
        let daily_rate = 1200; // Example daily rate

        // Calculate gross pay based on hours worked or daily rate
        let gross_pay = hoursWorked > 0 ? hoursWorked * hour_rate : daily_rate;

        // Calculate total deductions for the employee
        let employeeDeductions = deductionsData.filter(deduction => deduction.id === emp_id);
        console.log(`Deductions for Employee ID ${emp_id}:`, employeeDeductions); // Debug: Log deductions for the employee

        let deduction = employeeDeductions.reduce((sum, deduction) => {
            let amount = parseFloat(deduction.amount);
            if (isNaN(amount)) {
                console.warn(`Invalid deduction amount for ID ${emp_id}:`, deduction.amount);
                amount = 0;
            }
            return sum + amount;
        }, 0);

        // Debug: Log the calculated values
        console.log(`Employee ID: ${emp_id}, Gross Pay: ${gross_pay}, Total Deductions: ${deduction}`);

        let net_pay = gross_pay - deduction;

        let row = `<tr>
            <td>${emp_id}</td>
            <td>${emp_name}</td>
            <td>₱${daily_rate.toFixed(2)}</td>
            <td>₱${hour_rate.toFixed(2)}</td>
            <td>₱${gross_pay.toFixed(2)}</td> <!-- Gross Pay now here -->
            <td>₱${deduction.toFixed(2)}</td> <!-- Deductions now here -->
            <td>₱${net_pay.toFixed(2)}</td>
        </tr>`;
        payrollTableBody.innerHTML += row;
    });
}

async function fetchAttendanceData() {
    try {
        let response = await fetch("fetch_attendance.php");
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        let attendanceData = await response.json();
        if (attendanceData.error) {
            throw new Error(attendanceData.error);
        }
        return attendanceData;
    } catch (error) {
        console.error("Error fetching attendance data:", error);
        return [];
    }
}

async function fetchDeductionsData() {
    try {
        let response = await fetch("fetch_deduction.php");
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        let text = await response.text();
        console.log("Raw response:", text); // Log the raw response
        let deductionsData = JSON.parse(text);
        if (!Array.isArray(deductionsData)) {
            throw new Error("Deductions data is not an array");
        }
        return deductionsData;
    } catch (error) {
        console.error("Error fetching deductions data:", error);
        return [];
    }
}

function calculateHoursWorked(timeIn, timeOut) {
    if (!timeOut || timeOut.toLowerCase() === "null") return 0; // Handle missing time-out

    let start = new Date(`2025-01-01T${timeIn}`); // Use a fixed date with time
    let end = new Date(`2025-01-01T${timeOut}`);

    let hoursWorked = (end - start) / (1000 * 60 * 60); // Convert milliseconds to hours
    return hoursWorked > 0 ? hoursWorked : 0;
}

// Call the function when the page loads
document.addEventListener("DOMContentLoaded", fetchAttendanceAndCalculatePayroll);

// async function fetchAttendanceAndCalculatePayroll() {
//   try {
//     const attendanceData = await fetchAttendanceData();
//     const deductionsData = await fetchDeductionsData();

//     // Debug: Log the fetched data
//     console.log("Attendance Data:", attendanceData);
//     console.log("Deductions Data:", deductionsData);

//     calculatePayroll(attendanceData, deductionsData);
//   } catch (error) {
//     console.error("Error fetching and calculating payroll:", error);
//   }
// }

// function calculatePayroll(attendanceData, deductionsData) {
//   const payrollTableBody = document.querySelector("#payrollTable tbody");
//   if (!payrollTableBody) {
//     console.error("Payroll table body not found in the DOM.");
//     return;
//   }

//   payrollTableBody.innerHTML = ""; // Clear previous data

//   attendanceData.forEach((attendance) => {
//     const emp_id = attendance.id;
//     const emp_name = attendance.name;
//     const emp_timeIn = attendance.time_in;
//     const emp_timeOut = attendance.time_out;

//     const hour_rate = 150; // Example hourly rate
//     const daily_rate = 1200; // Example daily rate
//     const hoursWorked = calculateHoursWorked(emp_timeIn, emp_timeOut);

//     // Declare gross_pay here so it's available for net_pay
//     const gross_pay = hoursWorked > 0 ? hoursWorked * hour_rate : daily_rate;

//     // Get total deductions for this employee
//     const Deductions = deductionsData.filter(
//       (deduction) => deduction.id === emp_id
//     );
//     console.log(`Deductions for Employee ID ${emp_id}:, Deductions`); // Debug

//     const deduction = Deductions.reduce((sum, deduction) => {
//       let amount = parseFloat(deduction.amount);
//       if (isNaN(amount)) {
//         console.warn(
//           `Invalid deduction amount for ID ${emp_id}:,
//           deduction.amount`
//         );
//         amount=50 ;
//       }
//       return sum + amount;
//     }, 50);

//     // Calculate net pay
//     const net_pay = gross_pay - deduction;

//     // Debug log
//     console.log(
//       `Employee ID: ${emp_id}, Gross Pay: ${gross_pay}, Total Deductions: ${deduction}`
//     );

//     // Create a row dynamically and append it to the table
//     const row = document.createElement("tr");

//     row.innerHTML = `
//         <td>${emp_id}</td>
//         <td>${emp_name}</td>
//         <td>₱${daily_rate.toFixed(2)}</td>
//         <td>₱${hour_rate.toFixed(2)}</td>
//         <td>₱${gross_pay.toFixed(2)}</td>
//         <td>₱${deduction.toFixed(2)}</td> <!-- Display deduction -->
//         <td>₱${net_pay.toFixed(2)}</td>
//     `;

//     payrollTableBody.appendChild(row);
//   });
// }

// async function fetchAttendanceData() {
//   try {
//     let response = await fetch("fetch_attendance.php");
//     if (!response.ok) {
//       throw new Error(`HTTP error! Status: ${response.status}`);
//     }
//     let attendanceData = await response.json();
//     if (attendanceData.error) {
//       throw new Error(attendanceData.error);
//     }
//     return attendanceData;
//   } catch (error) {
//     console.error("Error fetching attendance data:", error);
//     return [];
//   }
// }

// async function fetchDeductionsData() {
//   try {
//     let response = await fetch("fetch_deduction.php");
//     if (!response.ok) {
//       throw new Error(`HTTP error! Status: ${response.status}`);
//     }
//     let text = await response.text();
//     console.log("Raw response:", text); // Log the raw response
//     let deductionsData = JSON.parse(text);
//     if (!Array.isArray(deductionsData)) {
//       throw new Error("Deductions data is not an array");
//     }
//     return deductionsData;
//   } catch (error) {
//     console.error("Error fetching deductions data:", error);
//     return [];
//   }
// }

// function calculateHoursWorked(timeIn, timeOut) {
//   if (!timeOut || timeOut.toLowerCase() === "null") return 0; // Handle missing time-out

//   const start = new Date(`2025-01-01T${timeIn}`); // Use a fixed date with time
//   const end = new Date(`2025-01-01T${timeOut}`);

//   const hoursWorked = (end - start) / (1000 * 60 * 60); // Convert milliseconds to hours
//   return hoursWorked > 0 ? hoursWorked : 0;
// }

// // Call the function when the page loads
// document.addEventListener("DOMContentLoaded", fetchAttendanceAndCalculatePayroll);


function fetchRecentlyDeleted() {
    fetch("fetch_recently_deleted.php")
        .then(response => response.json())
        .then(data => {
            let table = document.getElementById("recentlyDeletedList");
            table.innerHTML = "";
            data.forEach(row => {
                let tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${row.emp_id}</td>
                    <td>${row.name}</td>
                    <td>${row.department}</td>
                    <td>${row.position}</td>
                    <td>
                        <button class='restore-btn' onclick='restoreEmployee(${row.emp_id})'>Restore</button>
                        <button class='delete-btn' onclick='permanentlyDeleteEmployee(${row.emp_id})'>Delete Permanently</button>
                    </td>
                `;
                table.appendChild(tr);
            });
        })
        .catch(error => console.error("Error fetching data:", error));
}

function restoreEmployee(emp_id) {
    if (!confirm("Are you sure you want to restore this employee?")) return;

    fetch("restore_employee.php", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `emp_id=${emp_id}`
    })
    .then(response => response.text())
    .then(data => {
        alert(data);
        fetchRecentlyDeleted();
        fetchEmployees();
    })
    .catch(error => alert("Fetch error: " + error));
}

function permanentlyDeleteEmployee(emp_id) {
    if (!confirm("Are you sure you want to permanently delete this employee?")) return;

    fetch("permanently_delete_employee.php", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `emp_id=${emp_id}`
    })
    .then(response => response.text())
    .then(data => {
        alert(data);
        fetchRecentlyDeleted();
    })
    .catch(error => alert("Fetch error: " + error));
}

document.addEventListener("DOMContentLoaded", fetchRecentlyDeleted);



    document.addEventListener("DOMContentLoaded", fetchEmployees);
    </script>





</body>
</html>


